<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bean Chat â˜•</title>
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#3b1f0e"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Bean Chat"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,900;1,700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet"/>

<script type="module">
  import { initializeApp }   from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, onValue, set, remove, serverTimestamp, onDisconnect }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey:"AIzaSyDRRJLXyn3uThULrZbR8UT4Ne-TgPtRHV8",
    authDomain:"family-chat-cbd06.firebaseapp.com",
    databaseURL:"https://family-chat-cbd06-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"family-chat-cbd06",
    storageBucket:"family-chat-cbd06.firebasestorage.app",
    messagingSenderId:"844477717820",
    appId:"1:844477717820:web:6de2a12214fee094f85239"
  };
  const app=initializeApp(firebaseConfig), db=getDatabase(app);

  /* â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let username="", currentTable=null, currentScreen="login";
  let myOnlineRef=null, myTableSeatRef=null, myTypingRef=null;
  let soundOn=true, ambientOn=false;
  let isFirstLoad=true, typingTimer=null, isTyping=false;
  let ambientNode=null, ambientGain=null, clinkTimeout=null;
  let messagesUnsub=null, typingUnsub=null, seatsUnsub=null, tablesUnsub=null;
  let beanLevel=0, beanTimer=null, bgBeanInterval=null;

  /* â”€â”€ TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const TABLES=[
    {id:"mocha-java",     name:"Mocha Java",     emoji:"â˜•",color:"#5c2e0e",ring:"#9b5030",light:true, desc:"Dark & bold"},
    {id:"cappuccino",     name:"Cappuccino",     emoji:"ğŸ«§",color:"#b87040",ring:"#dda060",light:false,desc:"Frothy & warm"},
    {id:"latte",          name:"Latte",          emoji:"ğŸ¥›",color:"#c0a060",ring:"#ddc080",light:false,desc:"Smooth & mellow"},
    {id:"espresso",       name:"Espresso",       emoji:"âš¡",color:"#1a0a03",ring:"#4a2010",light:true, desc:"Intense & quick"},
    {id:"cold-brew",      name:"Cold Brew",      emoji:"ğŸ§Š",color:"#1e4a66",ring:"#3a7a9a",light:true, desc:"Chill & slow"},
    {id:"flat-white",     name:"Flat White",     emoji:"ğŸŒ¿",color:"#3a6a20",ring:"#60a040",light:true, desc:"Balanced & easy"},
    {id:"choc-mocha",     name:"Choc Mocha",     emoji:"ğŸ«",color:"#280e04",ring:"#6b2c10",light:true, desc:"Rich & indulgent"},
    {id:"chai-latte",     name:"Chai Latte",     emoji:"ğŸŒ¶ï¸",color:"#6e2008",ring:"#b84020",light:true, desc:"Spiced & soulful"},
  ];
  const FREE_ID="__freechat__";
  const FREE_INFO={id:FREE_ID,name:"The Floor",emoji:"ğŸ’¬",color:"#3b1f0e",ring:"#c8955c",light:true};

  /* â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const actx=new(window.AudioContext||window.webkitAudioContext)();
  function tone(f,t,v,d,rf){
    if(!soundOn)return;
    const o=actx.createOscillator(),g=actx.createGain();
    o.connect(g);g.connect(actx.destination);
    o.type=t||'sine';o.frequency.value=f;
    g.gain.setValueAtTime(v,actx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001,actx.currentTime+d);
    if(rf)o.frequency.exponentialRampToValueAtTime(rf,actx.currentTime+d);
    o.start();o.stop(actx.currentTime+d);
  }
  const playPing =()=>tone(880,'sine',.28,.5,660);
  const playSend =()=>tone(520,'sine',.15,.25,440);
  const playJoin =()=>[440,554,659].forEach((f,i)=>setTimeout(()=>tone(f,'sine',.18,.4),i*100));
  const playLeave=()=>[659,554,440].forEach((f,i)=>setTimeout(()=>tone(f,'sine',.14,.35),i*90));
  const playClink=()=>{if(ambientOn&&soundOn)tone(1800,'triangle',.06,.6,900);};
  function startAmbient(){
    if(ambientNode)return;actx.resume();
    const sz=actx.sampleRate*4,buf=actx.createBuffer(1,sz,actx.sampleRate),d=buf.getChannelData(0);
    let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
    for(let i=0;i<sz;i++){const w=Math.random()*2-1;b0=.99886*b0+w*.0555179;b1=.99332*b1+w*.0750759;b2=.969*b2+w*.153852;b3=.8665*b3+w*.3104856;b4=.55*b4+w*.5329522;b5=-.7616*b5-w*.016898;d[i]=(b0+b1+b2+b3+b4+b5+b6+w*.5362)*.11;b6=w*.115926;}
    const src=actx.createBufferSource();src.buffer=buf;src.loop=true;
    const fl=actx.createBiquadFilter();fl.type='lowpass';fl.frequency.value=420;
    ambientGain=actx.createGain();ambientGain.gain.setValueAtTime(0,actx.currentTime);ambientGain.gain.linearRampToValueAtTime(.18,actx.currentTime+2);
    src.connect(fl);fl.connect(ambientGain);ambientGain.connect(actx.destination);src.start();ambientNode=src;schedClink();
  }
  function stopAmbient(){if(!ambientNode)return;ambientGain.gain.linearRampToValueAtTime(0,actx.currentTime+1.5);setTimeout(()=>{try{ambientNode.stop();}catch(e){}ambientNode=null;},1600);}
  function schedClink(){if(!ambientOn)return;clinkTimeout=setTimeout(()=>{playClink();schedClink();},8000+Math.random()*14000);}
  window.toggleAmbient=()=>{
    ambientOn=!ambientOn;
    document.querySelectorAll('.amb-btn').forEach(b=>{b.classList.toggle('on',ambientOn);});
    ambientOn?startAmbient():(stopAmbient(),clearTimeout(clinkTimeout));
  };
  window.toggleSound=()=>{
    soundOn=!soundOn;
    document.querySelectorAll('.snd-btn').forEach(b=>{b.textContent=soundOn?'ğŸ””':'ğŸ”•';b.classList.toggle('off',!soundOn);});
    if(soundOn)actx.resume();
  };

  /* â”€â”€ SPECIALS / TIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const SPECIALS=[
    {drink:"Honey Oat Latte",note:"A golden hug in a cup"},
    {drink:"Cardamom Flat White",note:"Spice up your morning"},
    {drink:"Brown Sugar Cold Brew",note:"Smooth & slow, just like Sundays"},
    {drink:"Lavender Cortado",note:"Soft as a quiet afternoon"},
    {drink:"Hazelnut Cappuccino",note:"Nutty, warm, familiar"},
    {drink:"Cinnamon Americano",note:"Bold with a little sweetness"},
    {drink:"Vanilla Bean Macchiato",note:"Simple things done perfectly"},
  ];
  const special=SPECIALS[new Date().getDay()%SPECIALS.length];
  const specialStr=`${special.drink} â€” ${special.note}`;
  function timeGreet(){const h=new Date().getHours();return h<11?'Good morning â˜€ï¸':h<15?'Good afternoon â˜ï¸':h<19?'Golden hour ğŸŒ‡':'Evening ğŸŒ™';}
  function applyTime(){
    const h=new Date().getHours();let t='evening';
    if(h>=5&&h<11)t='morning';else if(h<15)t='noon';else if(h<19)t='afternoon';
    document.documentElement.setAttribute('data-time',t);
    document.querySelectorAll('.time-greet').forEach(e=>e.textContent=timeGreet());
  }

  /* â”€â”€ BEANS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const BEANS=['ğŸ«˜','ğŸ«˜','ğŸ«˜','â˜•','â˜•','ğŸ¥','ğŸµ','ğŸ«','âœ¨','ğŸŒ¿'];
  function spawnFlyBean(big){
    const host=document.getElementById('chatBox');if(!host)return;
    const el=document.createElement('div');el.className='fly-bean';
    el.textContent=BEANS[Math.floor(Math.random()*BEANS.length)];
    el.style.left=(5+Math.random()*88)+'%';
    el.style.fontSize=(big?22+Math.random()*14:12+Math.random()*10)+'px';
    el.style.animationDuration=(1.4+Math.random()*1.4)+'s';
    el.style.animationDelay=(Math.random()*.3)+'s';
    host.appendChild(el);setTimeout(()=>el.remove(),3000);
  }
  function burst(n){
    beanLevel=Math.min(beanLevel+1,6);clearTimeout(beanTimer);beanTimer=setTimeout(()=>beanLevel=Math.max(0,beanLevel-1),4000);
    const tot=beanLevel+(n||0);for(let i=0;i<tot;i++)setTimeout(()=>spawnFlyBean(beanLevel>=3),i*110);
  }
  const CWORDS=['coffee','espresso','latte','cappuccino','flat white','americano','mocha','brew','cup','sip','bean','cafÃ©','cortado','macchiato','cold brew','chocolate','chai'];
  function coffeeCheck(t){if(CWORDS.some(k=>t.toLowerCase().includes(k)))burst(2);}

  function startBgBeans(hostId){
    stopBgBeans();
    bgBeanInterval=setInterval(()=>{
      const host=document.getElementById(hostId);if(!host)return;
      const el=document.createElement('div');el.className='bg-bean';
      el.textContent=BEANS[Math.floor(Math.random()*BEANS.length)];
      el.style.left=Math.random()*100+'%';
      el.style.fontSize=(14+Math.random()*20)+'px';
      el.style.animationDuration=(7+Math.random()*9)+'s';
      el.style.opacity=.03+Math.random()*.08;
      host.appendChild(el);setTimeout(()=>el.remove(),16000);
    },1800);
  }
  function stopBgBeans(){clearInterval(bgBeanInterval);bgBeanInterval=null;}

  /* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function showScreen(id){
    ['loginScreen','floorScreen','tablesRoom','chatBox'].forEach(s=>{
      const el=document.getElementById(s);if(el)el.style.display='none';
    });
    const el=document.getElementById(id);if(el)el.style.display='flex';
    currentScreen=id;
  }

  /* â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  window.joinChat=()=>{
    const n=document.getElementById('nameInput').value.trim();
    if(!n){const i=document.getElementById('nameInput');i.classList.add('shake');setTimeout(()=>i.classList.remove('shake'),500);return;}
    username=n;actx.resume();
    myOnlineRef=ref(db,'online/'+username);
    set(myOnlineRef,{name:username,joinedAt:Date.now()});
    onDisconnect(myOnlineRef).remove();
    showScreen('floorScreen');
    initFloor();
  };
  window.handleJoinKey=e=>{if(e.key==='Enter')window.joinChat();};

  /* â”€â”€ FLOOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function initFloor(){
    document.getElementById('floorUserAv').textContent=username[0].toUpperCase();
    document.getElementById('floorUserName').textContent=username;
    document.querySelectorAll('.special-fill').forEach(e=>e.textContent=specialStr);
    applyTime();setInterval(applyTime,60000);
    startBgBeans('floorScreen');
    listenTablesOverview(); // keep floor count live
    enterRoom(FREE_ID,FREE_INFO,false);
  }
  window.goToTables=()=>{
    stopBgBeans();
    showScreen('tablesRoom');
    document.getElementById('tablesUserAv').textContent=username[0].toUpperCase();
    document.querySelectorAll('.special-fill').forEach(e=>e.textContent=specialStr);
    renderRoundTables();
    listenTablesOverview();
    startBgBeans('tablesRoomBody');
  };
  // New: go from Tables back to floor without disturbing the floor session
  window.tablesBackToFloor=()=>{
    stopBgBeans();
    showScreen('floorScreen');
    startBgBeans('floorScreen');
    // re-attach floor seat if we left it
    if(!currentTable||currentTable!==FREE_ID){
      if(currentTable&&currentTable!==FREE_ID){leaveRoomSilent();}
      enterRoom(FREE_ID,FREE_INFO,false);
    }
  };
  window.backToFloor=()=>{
    stopBgBeans();
    // if in a private table, announce leave
    if(currentTable&&currentTable!==FREE_ID){
      push(ref(db,`tables/${currentTable}/messages`),{type:'system',text:`${username} headed back to the floor ğŸ‘£`,ts:serverTimestamp()});
      playLeave();leaveRoomSilent();
    }
    showScreen('floorScreen');
    startBgBeans('floorScreen');
    // re-enter free chat
    enterRoom(FREE_ID,FREE_INFO,false);
  };

  /* â”€â”€ TABLES ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function renderRoundTables(){
    const grid=document.getElementById('roundTablesGrid');grid.innerHTML='';
    TABLES.forEach((t,i)=>{
      const wrap=document.createElement('div');wrap.className='rt-wrap';wrap.style.animationDelay=(i*.065)+'s';
      const tcText=t.light?'#faf6f0':'#1e0a04';
      wrap.innerHTML=`
        <div class="rt-outer" style="--tc:${t.color};--tr:${t.ring};--tct:${tcText}" onclick="selectTable('${t.id}')">
          <div class="rt-sheen"></div>
          <div class="rt-inner">
            <span class="rt-cup">${t.emoji}</span>
            <div class="rt-name">${t.name}</div>
            <div class="rt-seats" id="rts-${t.id}"><span class="rt-empty">empty</span></div>
          </div>
          <div class="rt-leg rl"></div>
          <div class="rt-leg rr"></div>
          <div class="rt-wisp rw1"></div>
          <div class="rt-wisp rw2"></div>
        </div>
        <div class="rt-label">
          <div class="rt-lname">${t.name}</div>
          <div class="rt-ldesc">${t.desc}</div>
        </div>`;
      grid.appendChild(wrap);
    });
  }

  function listenTablesOverview(){
    if(tablesUnsub)tablesUnsub();
    tablesUnsub=onValue(ref(db,'tables'),snap=>{
      TABLES.forEach(t=>{
        const el=document.getElementById('rts-'+t.id);if(!el)return;
        if(!snap.exists()||!snap.child(t.id).child('seats').exists()){el.innerHTML='<span class="rt-empty">empty</span>';return;}
        const ns=[];snap.child(t.id).child('seats').forEach(c=>ns.push(c.val().name));
        el.innerHTML=ns.length?ns.map(n=>`<span class="rt-chip">${n[0].toUpperCase()}</span>`).join(''):'<span class="rt-empty">empty</span>';
      });
      // update floor count
      const fEl=document.getElementById('floorCount');
      if(fEl&&snap.exists()&&snap.child(FREE_ID).child('seats').exists()){
        const ns=[];snap.child(FREE_ID).child('seats').forEach(c=>ns.push(c.val().name));
        fEl.textContent=ns.length>1?`${ns.length} people chatting`:ns.length===1?'1 person here':'Just you right now';
      }
    });
  }

  window.selectTable=id=>{
    const info=TABLES.find(t=>t.id===id);if(!info)return;
    stopBgBeans();
    if(currentTable&&currentTable!==FREE_ID){
      push(ref(db,`tables/${currentTable}/messages`),{type:'system',text:`${username} moved to another table ğŸ‘‹`,ts:serverTimestamp()});
      leaveRoomSilent();
    } else if(currentTable===FREE_ID){
      leaveRoomSilent();
    }
    enterRoom(id,info,true);
    showScreen('chatBox');
  };

  /* â”€â”€ ROOM LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function enterRoom(id,info,announce){
    currentTable=id;
    myTableSeatRef=ref(db,`tables/${id}/seats/${username}`);
    set(myTableSeatRef,{name:username,joinedAt:Date.now()});
    onDisconnect(myTableSeatRef).remove();
    if(announce)push(ref(db,`tables/${id}/messages`),{type:'system',text:`${username} pulled up a chair â˜•`,ts:serverTimestamp()});
    myTypingRef=ref(db,`tables/${id}/typing/${username}`);
    showChatUI(info);
    playJoin();burst(3);
  }

  function leaveRoomSilent(){
    if(!currentTable)return;
    if(myTableSeatRef){remove(myTableSeatRef);myTableSeatRef=null;}
    if(myTypingRef){remove(myTypingRef);myTypingRef=null;}
    if(messagesUnsub){messagesUnsub();messagesUnsub=null;}
    if(typingUnsub){typingUnsub();typingUnsub=null;}
    if(seatsUnsub){seatsUnsub();seatsUnsub=null;}
    currentTable=null;isFirstLoad=true;
  }

  window.leaveChat=()=>{
    if(!currentTable)return;
    const wasTable=currentTable!==FREE_ID;
    push(ref(db,`tables/${currentTable}/messages`),{type:'system',text:`${username} left the table ğŸ‘‹`,ts:serverTimestamp()});
    playLeave();leaveRoomSilent();
    stopBgBeans();
    if(wasTable){
      showScreen('tablesRoom');
      renderRoundTables();listenTablesOverview();
      startBgBeans('tablesRoomBody');
    }else{
      showScreen('floorScreen');
      startBgBeans('floorScreen');
      enterRoom(FREE_ID,FREE_INFO,false);
    }
  };

  /* â”€â”€ CHAT UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  // Return the correct element IDs depending on which screen is showing
  function msgsEl()   { return document.getElementById(currentScreen==='floorScreen'?'floorMsgs':'chatMsgs'); }
  function inputEl()  { return document.getElementById(currentScreen==='floorScreen'?'floorMsgInput':'chatMsgInput'); }
  function typingEl() { return document.getElementById(currentScreen==='floorScreen'?'floorTypingBar':'chatTypingBar'); }

  function showChatUI(info){
    const isFloor=info.id===FREE_ID;
    if(!isFloor){
      // style the private table chat header
      const chatBox=document.getElementById('chatBox');
      chatBox.style.setProperty('--tc',info.color);
      chatBox.style.setProperty('--tr',info.ring||info.color);
      document.getElementById('chatHeaderEmoji').textContent=info.emoji;
      document.getElementById('chatHeaderBadge').textContent=info.name;
      document.getElementById('chatHeaderUser').textContent=username[0].toUpperCase();
      document.getElementById('chatHeaderUserName').textContent=username;
      document.getElementById('chatBackBtn').textContent='â† Tables';
      document.getElementById('chatSpecialFill').textContent=specialStr;
      document.getElementById('chatTimeGreet').textContent=timeGreet();
      document.getElementById('chatMsgs').innerHTML='';
      document.getElementById('chatTypingBar').innerHTML='';
      document.getElementById('chatTypingBar').style.display='none';
      document.getElementById('chatSeatsBar').style.display='flex';
    } else {
      document.getElementById('floorMsgs').innerHTML='';
      document.getElementById('floorTypingBar').innerHTML='';
      document.getElementById('floorTypingBar').style.display='none';
    }
    isFirstLoad=true;
    listenMessages();
    if(!isFloor)listenSeats();
    listenTyping();
    inputEl().focus();
  }

  window.sendMessage=()=>{
    const inp=inputEl(),text=inp.value.trim();
    if(!text||!currentTable)return;
    inp.value='';setTyping(false);clearTimeout(typingTimer);
    playSend();coffeeCheck(text);burst(1);
    push(ref(db,`tables/${currentTable}/messages`),{type:'message',user:username,text,ts:serverTimestamp()});
  };
  window.handleMsgKey=e=>{
    if(e.key==='Enter'){window.sendMessage();return;}
    setTyping(true);clearTimeout(typingTimer);typingTimer=setTimeout(()=>setTyping(false),1800);
  };

  function setTyping(v){
    if(!myTypingRef)return;
    if(v&&!isTyping){isTyping=true;set(myTypingRef,{name:username,ts:Date.now()});}
    else if(!v&&isTyping){isTyping=false;set(myTypingRef,null);}
  }

  function listenTyping(){
    if(typingUnsub)typingUnsub();
    typingUnsub=onValue(ref(db,`tables/${currentTable}/typing`),snap=>{
      const bar=typingEl();
      if(!snap.exists()){bar.innerHTML='';bar.style.display='none';return;}
      const ts=[];snap.forEach(c=>{const d=c.val();if(d.name!==username)ts.push(d.name);});
      if(!ts.length){bar.innerHTML='';bar.style.display='none';return;}
      bar.style.display='flex';
      bar.innerHTML=`<div class="tcups"><span class="tc">â˜•</span><span class="tc">â˜•</span><span class="tc">â˜•</span></div><span class="ttext">${ts.join(', ')} ${ts.length===1?'is':'are'} brewing a replyâ€¦</span>`;
    });
  }

  function listenSeats(){
    if(seatsUnsub)seatsUnsub();
    seatsUnsub=onValue(ref(db,`tables/${currentTable}/seats`),snap=>{
      const p=document.getElementById('chatSeatsList');p.innerHTML='';
      if(!snap.exists()){p.innerHTML='<span class="no-one">Just youâ€¦</span>';return;}
      snap.forEach(c=>{
        const u=c.val(),pill=document.createElement('div');pill.className='seat-pill';
        pill.innerHTML=`<span class="s-dot"></span><span class="s-name">${u.name}</span>`;
        p.appendChild(pill);
      });
    });
  }

  function listenMessages(){
    if(messagesUnsub)messagesUnsub();
    messagesUnsub=onValue(ref(db,`tables/${currentTable}/messages`),snap=>{
      const box=msgsEl();box.innerHTML='';
      if(!snap.exists()){box.innerHTML='<div class="empty-state">The table is set.<br/>Say something warm. â˜•</div>';isFirstLoad=false;return;}
      snap.forEach(child=>{
        const msg=child.val();
        if(msg.type==='system'){
          const el=document.createElement('div');el.className='sys-msg';el.textContent=msg.text;box.appendChild(el);
        }else{
          const mine=msg.user===username;
          const wrap=document.createElement('div');wrap.className='msg-wrap '+(mine?'mine':'theirs');
          const av=document.createElement('div');av.className='av '+(mine?'av-mine':'av-them');av.textContent=msg.user[0].toUpperCase();
          const inn=document.createElement('div');inn.className='msg-inner';
          const meta=document.createElement('div');meta.className='meta';
          const t=msg.ts?new Date(msg.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):'';
          meta.textContent=`${msg.user} Â· ${t}`;
          const bub=document.createElement('div');bub.className='bub '+(mine?'bub-mine':'bub-them');bub.textContent=msg.text;
          inn.append(meta,bub);mine?wrap.append(inn,av):wrap.append(av,inn);box.appendChild(wrap);
        }
      });
      if(!isFirstLoad)playPing();
      isFirstLoad=false;box.scrollTop=box.scrollHeight;
    });
  }

  document.addEventListener('DOMContentLoaded',()=>{
    document.getElementById('loginSpecialDrink').textContent=special.drink;
    document.getElementById('loginSpecialNote').textContent=special.note;
    applyTime();
  });
</script>

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOKENS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --cream:#faf6f0;--parchment:#f2ead8;--latte:#e8d9be;
  --caramel:#c8955c;--espresso:#3b1f0e;--mocha:#6b3a1f;
  --roast:#8b4513;--foam:#fdf8f0;--ink:#2c1a0e;--mid:#9b7b5a;
  --border:#ddd0b8;--shadow:0 8px 40px rgba(59,31,14,.13);
  --tc:#6b3a1f;--tr:#c8955c;
}
[data-time=morning]  {--bg1:rgba(255,200,80,.10);--bg2:rgba(200,120,50,.07);}
[data-time=noon]     {--bg1:rgba(200,149,92,.09);--bg2:rgba(107,58,31,.07);}
[data-time=afternoon]{--bg1:rgba(210,100,30,.12);--bg2:rgba(140,60,20,.09);}
[data-time=evening]  {--bg1:rgba(50,15,2,.18);   --bg2:rgba(20,8,2,.14);}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{
  min-height:100vh;font-family:'Lato',sans-serif;color:var(--ink);
  background:var(--parchment);
  background-image:
    radial-gradient(ellipse at 20% 10%,var(--bg1,rgba(200,149,92,.10)) 0%,transparent 60%),
    radial-gradient(ellipse at 80% 90%,var(--bg2,rgba(107,58,31,.08)) 0%,transparent 60%);
  display:flex;flex-direction:column;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• KEYFRAMES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeUp {from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
@keyframes steamUp{0%{transform:translateY(0)scaleX(1);opacity:.6}50%{transform:translateY(-16px)scaleX(1.3);opacity:.3}100%{transform:translateY(-32px)scaleX(.8);opacity:0}}
@keyframes bob    {0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
@keyframes blink  {0%,100%{opacity:1}50%{opacity:.3}}
@keyframes popIn  {from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
@keyframes msgIn  {from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
@keyframes flyUp  {0%{transform:translateY(0)rotate(0)scale(1);opacity:1}100%{transform:translateY(-160px)rotate(32deg)scale(1.5);opacity:0}}
@keyframes bgRise {0%{transform:translateY(110vh)rotate(0);opacity:0}8%{opacity:1}92%{opacity:.7}100%{transform:translateY(-80px)rotate(18deg);opacity:0}}
@keyframes shake  {0%,100%{transform:translateX(0)}25%{transform:translateX(-7px)}75%{transform:translateX(7px)}}
@keyframes glow   {0%,100%{box-shadow:0 0 8px rgba(200,149,92,.3)}50%{box-shadow:0 0 20px rgba(200,149,92,.7)}}
@keyframes chalkIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
@keyframes tableIn{from{opacity:0;transform:scale(.85)translateY(20px)}to{opacity:1;transform:scale(1)translateY(0)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BEANS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fly-bean{position:absolute;pointer-events:none;z-index:600;bottom:80px;animation:flyUp 2.4s ease-out forwards;filter:drop-shadow(0 2px 5px rgba(59,31,14,.3));}
.bg-bean {position:absolute;pointer-events:none;z-index:0;bottom:-50px;animation:bgRise 13s linear forwards;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SHARED COMPONENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-header{
  background:linear-gradient(135deg,var(--espresso),var(--mocha));
  padding:12px 16px;display:flex;align-items:center;gap:9px;flex-shrink:0;
  border-bottom:2.5px solid var(--caramel);position:relative;overflow:hidden;
}
.page-header::after{content:'';position:absolute;right:-18px;top:-18px;width:78px;height:78px;border-radius:50%;border:10px solid rgba(200,149,92,.12);pointer-events:none;}
.ph-logo{width:40px;height:40px;border-radius:50%;background:linear-gradient(145deg,var(--caramel),var(--mocha));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,.3);animation:bob 3s ease-in-out infinite;}
.ph-text{flex:1;min-width:0;}
.ph-title{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:var(--cream);letter-spacing:-.3px;display:flex;align-items:center;gap:7px;}
.ph-title em{font-style:italic;color:var(--caramel);}
.ph-sub{font-size:9px;color:rgba(250,246,240,.5);letter-spacing:1.5px;text-transform:uppercase;margin-top:2px;display:flex;align-items:center;gap:5px;}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--caramel);display:inline-block;animation:blink 2s infinite;}
.hbtn{background:rgba(250,246,240,.10);border:1.5px solid rgba(200,149,92,.35);border-radius:50%;width:35px;height:35px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;flex-shrink:0;transition:background .2s,transform .15s;padding:0;color:inherit;}
.hbtn:hover{background:rgba(200,149,92,.22);transform:scale(1.1);}.hbtn:active{transform:scale(.93);}
.hbtn.off{opacity:.45;}.hbtn.on{background:rgba(200,149,92,.3);animation:glow 2s infinite;}
.upill{background:rgba(250,246,240,.10);border:1px solid rgba(200,149,92,.3);border-radius:999px;padding:5px 11px 5px 6px;display:flex;align-items:center;gap:6px;flex-shrink:0;}
.uav{width:24px;height:24px;border-radius:50%;background:var(--caramel);color:var(--foam);font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;}
.uname{font-size:12px;color:var(--cream);font-weight:400;max-width:68px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.chalk{background:#1a0d04;border-bottom:2px solid #3a2010;padding:6px 16px;display:flex;align-items:center;gap:9px;flex-shrink:0;position:relative;overflow:hidden;}
.chalk::before{content:'';position:absolute;inset:0;background:repeating-linear-gradient(90deg,transparent,transparent 40px,rgba(255,255,255,.015)40px,rgba(255,255,255,.015)41px);}
.ck-l{font-size:9px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:#c8955c;white-space:nowrap;flex-shrink:0;}
.ck-d{font-family:'Playfair Display',serif;font-size:12px;font-style:italic;color:#f5ead0;font-weight:700;}
.ck-t{font-size:9px;color:rgba(200,149,92,.7);letter-spacing:1.5px;text-transform:uppercase;margin-left:auto;white-space:nowrap;flex-shrink:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#loginScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:24px;}
.lcard{background:var(--foam);border:1.5px solid var(--latte);border-radius:28px;padding:48px 42px 40px;width:100%;max-width:390px;box-shadow:var(--shadow),inset 0 1px 0 rgba(255,255,255,.8);text-align:center;animation:fadeUp .6s ease;position:relative;overflow:hidden;}
.lcard::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,var(--caramel),var(--mocha),var(--caramel));}
.bean-emb{position:relative;width:92px;height:92px;margin:0 auto 24px;}
.bean-ring{width:92px;height:92px;border-radius:50%;background:linear-gradient(145deg,var(--mocha),var(--espresso));display:flex;align-items:center;justify-content:center;font-size:40px;box-shadow:0 0 0 4px var(--foam),0 0 0 8px var(--caramel),0 0 0 12px var(--foam),0 8px 24px rgba(59,31,14,.3);}
.steam-w{position:absolute;top:-10px;left:50%;transform:translateX(-50%);display:flex;gap:8px;}
.steam-l{width:3px;height:17px;background:linear-gradient(to top,var(--caramel),transparent);border-radius:3px;animation:steamUp 2s ease-in-out infinite;}
.steam-l:nth-child(2){animation-delay:.5s;height:13px;}.steam-l:nth-child(3){animation-delay:1s;height:19px;}
.lcard h1{font-family:'Playfair Display',serif;font-size:34px;font-weight:900;color:var(--espresso);letter-spacing:-1.5px;margin-bottom:3px;}
.lcard h1 em{font-style:italic;color:var(--caramel);}
.tagline{font-size:11px;color:var(--mid);letter-spacing:2.5px;margin-bottom:18px;text-transform:uppercase;font-weight:300;}
.lspecial{background:#2a1a08;border-radius:12px;padding:9px 16px 11px;margin-bottom:22px;border:2px solid #5a3a1a;animation:chalkIn .5s ease .4s both;}
.lspecial::before{content:"â˜• Today's Special";display:block;font-size:9px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:#c8955c;margin-bottom:4px;}
.ls-drink{font-family:'Playfair Display',serif;font-size:15px;font-style:italic;color:#faf6f0;font-weight:700;}
.ls-note{font-size:11px;color:#c0a070;margin-top:2px;}
.inp-g{text-align:left;margin-bottom:15px;}
.inp-g label{display:block;font-size:10px;font-weight:700;letter-spacing:2px;color:var(--mid);margin-bottom:8px;text-transform:uppercase;}
.inp-g input{width:100%;border:1.5px solid var(--border);border-radius:13px;padding:13px 17px;font-size:15px;font-family:'Lato',sans-serif;color:var(--ink);background:var(--cream);outline:none;transition:border-color .2s,box-shadow .2s;}
.inp-g input:focus{border-color:var(--caramel);background:var(--foam);box-shadow:0 0 0 3px rgba(200,149,92,.18);}
.inp-g input.shake{animation:shake .4s ease;}
.join-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--mocha),var(--espresso));color:var(--cream);border:none;border-radius:13px;font-size:15px;font-weight:700;font-family:'Lato',sans-serif;cursor:pointer;letter-spacing:.5px;transition:opacity .2s,transform .1s;box-shadow:0 4px 16px rgba(59,31,14,.25);}
.join-btn:hover{opacity:.88;}.join-btn:active{transform:scale(.98);}
.l-btns{display:flex;gap:10px;justify-content:center;margin-top:13px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FLOOR SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#floorScreen{display:none;flex-direction:column;height:100vh;height:100dvh;position:relative;overflow:hidden;}
.floor-welcome{
  padding:12px 18px 11px;display:flex;align-items:center;justify-content:space-between;
  background:linear-gradient(180deg,rgba(59,31,14,.06)0%,transparent 100%);
  border-bottom:1px solid var(--border);flex-shrink:0;
}
.fw-left{}
.fw-left h2{font-family:'Playfair Display',serif;font-size:16px;font-style:italic;color:var(--espresso);font-weight:700;}
.fw-left h2 em{color:var(--caramel);}
.fw-left p{font-size:11px;color:var(--mid);margin-top:2px;}
.fw-count{font-size:11px;color:var(--caramel);font-weight:700;text-align:right;flex-shrink:0;}
/* Tables button â€” pill style */
.tables-btn{
  display:flex;align-items:center;gap:7px;
  background:linear-gradient(135deg,var(--mocha),var(--espresso));
  color:var(--cream);border:none;border-radius:999px;
  padding:9px 18px;font-size:13px;font-weight:700;font-family:'Lato',sans-serif;
  cursor:pointer;letter-spacing:.3px;
  box-shadow:0 3px 14px rgba(59,31,14,.28);
  transition:opacity .2s,transform .1s;
  flex-shrink:0;white-space:nowrap;
}
.tables-btn:hover{opacity:.88;transform:translateY(-1px);}
.tables-btn:active{transform:scale(.97);}
/* Group sound/ambient buttons together so they don't float apart */
.ph-actions{display:flex;align-items:center;gap:6px;flex-shrink:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TABLES ROOM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#tablesRoom{display:none;flex-direction:column;height:100vh;height:100dvh;position:relative;overflow:hidden;}
#tablesRoomBody{
  flex:1;overflow-y:auto;padding:22px 18px 40px;
  position:relative;
  background:
    radial-gradient(ellipse at 30% 20%,rgba(200,149,92,.07)0%,transparent 55%),
    radial-gradient(ellipse at 70% 80%,rgba(107,58,31,.05)0%,transparent 55%),
    var(--parchment);
}
/* wood-floor texture */
#tablesRoomBody::before{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:
    repeating-linear-gradient(0deg,transparent,transparent 48px,rgba(139,69,19,.018)48px,rgba(139,69,19,.018)49px),
    repeating-linear-gradient(90deg,transparent,transparent 48px,rgba(139,69,19,.014)48px,rgba(139,69,19,.014)49px);
}
.tr-intro{text-align:center;margin-bottom:26px;position:relative;z-index:1;}
.tr-intro h3{font-family:'Playfair Display',serif;font-size:19px;font-weight:700;color:var(--espresso);}
.tr-intro h3 em{font-style:italic;color:var(--caramel);}
.tr-intro p{font-size:12px;color:var(--mid);margin-top:4px;font-style:italic;}

#roundTablesGrid{
  display:grid;grid-template-columns:repeat(4,1fr);
  gap:36px 14px;position:relative;z-index:1;justify-items:center;
}
/* â”€â”€ ROUND TABLE â”€â”€ */
.rt-wrap{animation:tableIn .5s ease both;display:flex;flex-direction:column;align-items:center;}
.rt-outer{
  position:relative;width:128px;height:128px;border-radius:50%;
  background:radial-gradient(circle at 36% 30%,
    color-mix(in srgb,var(--tc) 55%,white 45%) 0%,
    var(--tc) 55%,
    color-mix(in srgb,var(--tc) 55%,black 45%) 100%);
  border:5px solid var(--tr);
  box-shadow:
    0 0 0 2px color-mix(in srgb,var(--tr) 30%,white 70%),
    inset 0 5px 14px rgba(255,255,255,.18),
    inset 0 -5px 12px rgba(0,0,0,.28),
    0 14px 30px rgba(0,0,0,.24),
    0 4px 8px rgba(0,0,0,.14);
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:transform .28s cubic-bezier(.34,1.56,.64,1),box-shadow .28s;overflow:visible;
}
.rt-outer:hover{
  transform:translateY(-8px)scale(1.06);
  box-shadow:
    0 0 0 2px color-mix(in srgb,var(--tr) 30%,white 70%),
    inset 0 5px 14px rgba(255,255,255,.18),
    inset 0 -5px 12px rgba(0,0,0,.28),
    0 22px 44px rgba(0,0,0,.3),
    0 6px 16px rgba(0,0,0,.18);
}
.rt-outer:active{transform:scale(.95);}
/* specular sheen */
.rt-sheen{
  position:absolute;width:52%;height:38%;top:11%;left:14%;border-radius:50%;
  background:radial-gradient(ellipse at 50% 20%,rgba(255,255,255,.30)0%,transparent 70%);
  pointer-events:none;
}
.rt-inner{display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;border-radius:50%;padding:10px;text-align:center;position:relative;z-index:1;}
.rt-cup{font-size:28px;margin-bottom:4px;display:block;filter:drop-shadow(0 2px 4px rgba(0,0,0,.35));}
.rt-name{font-family:'Playfair Display',serif;font-size:10.5px;font-weight:700;color:var(--tct,#faf6f0);line-height:1.2;text-shadow:0 1px 3px rgba(0,0,0,.45);}
.rt-seats{display:flex;gap:3px;justify-content:center;flex-wrap:wrap;margin-top:5px;}
.rt-chip{width:16px;height:16px;border-radius:50%;background:rgba(255,255,255,.22);border:1.5px solid rgba(255,255,255,.5);font-size:8px;font-weight:700;color:var(--tct,#faf6f0);display:flex;align-items:center;justify-content:center;}
.rt-empty{font-size:8px;color:rgba(250,246,240,.4);font-style:italic;}
/* legs */
.rt-leg{position:absolute;bottom:-22px;width:9px;height:24px;background:linear-gradient(180deg,color-mix(in srgb,var(--tc)50%,#3a1a05 50%)0%,#221005 100%);border-radius:0 0 4px 4px;}
.rt-leg.rl{left:30%;transform:rotate(-12deg);}
.rt-leg.rr{right:30%;transform:rotate(12deg);}
/* steam wisps */
.rt-wisp{position:absolute;top:-9px;width:3px;height:11px;background:linear-gradient(to top,rgba(200,149,92,.55),transparent);border-radius:3px;pointer-events:none;animation:steamUp 2.8s ease-in-out infinite;}
.rt-wisp.rw1{left:38%;animation-delay:0s;}
.rt-wisp.rw2{left:54%;animation-delay:.9s;height:8px;}
/* label below table */
.rt-label{margin-top:18px;text-align:center;}
.rt-lname{font-family:'Playfair Display',serif;font-size:12px;font-weight:700;color:var(--espresso);}
.rt-ldesc{font-size:10px;color:var(--mid);font-style:italic;margin-top:1px;}
/* nth delays */
.rt-wrap:nth-child(1){animation-delay:.04s;}.rt-wrap:nth-child(2){animation-delay:.09s;}
.rt-wrap:nth-child(3){animation-delay:.13s;}.rt-wrap:nth-child(4){animation-delay:.17s;}
.rt-wrap:nth-child(5){animation-delay:.21s;}.rt-wrap:nth-child(6){animation-delay:.25s;}
.rt-wrap:nth-child(7){animation-delay:.29s;}.rt-wrap:nth-child(8){animation-delay:.33s;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAT BOX â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#chatBox{display:none;flex-direction:column;height:100vh;height:100dvh;position:relative;overflow:hidden;}
.tbadge{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;background:rgba(200,149,92,.22);border:1px solid rgba(200,149,92,.4);border-radius:6px;padding:2px 7px;color:var(--caramel);}
.back-btn{background:rgba(250,246,240,.10);border:1.5px solid rgba(200,149,92,.35);border-radius:10px;padding:6px 12px;color:var(--caramel);font-size:12px;font-weight:700;font-family:'Lato',sans-serif;cursor:pointer;flex-shrink:0;transition:background .2s,transform .15s;}
.back-btn:hover{background:rgba(200,149,92,.22);}.back-btn:active{transform:scale(.96);}
.seats-bar{background:var(--foam);border-bottom:1px solid var(--border);padding:7px 16px;display:flex;align-items:center;gap:9px;flex-shrink:0;overflow-x:auto;min-height:40px;}
.seats-label{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--mid);text-transform:uppercase;white-space:nowrap;flex-shrink:0;}
#chatSeatsList{display:flex;gap:6px;flex-wrap:nowrap;align-items:center;}
.seat-pill{display:flex;align-items:center;gap:5px;background:rgba(200,149,92,.12);border:1px solid rgba(200,149,92,.35);border-radius:999px;padding:3px 10px 3px 6px;animation:popIn .3s ease;}
.s-dot{width:6px;height:6px;border-radius:50%;background:var(--caramel);animation:blink 1.8s infinite;flex-shrink:0;}
.s-name{font-size:12px;font-weight:700;color:var(--mocha);white-space:nowrap;}
.no-one{font-size:12px;color:#c0a882;font-style:italic;}
#chatMsgs,#floorMsgs{flex:1;overflow-y:auto;padding:16px 15px;display:flex;flex-direction:column;gap:10px;background:var(--parchment);background-image:radial-gradient(ellipse at 75% 25%,rgba(200,149,92,.07)0%,transparent 50%),radial-gradient(ellipse at 15% 20%,rgba(200,149,92,.07)0%,transparent 50%),radial-gradient(ellipse at 85% 80%,rgba(107,58,31,.05)0%,transparent 50%);}
#chatMsgs::-webkit-scrollbar,#floorMsgs::-webkit-scrollbar{width:4px;}#chatMsgs::-webkit-scrollbar-thumb,#floorMsgs::-webkit-scrollbar-thumb{background:var(--latte);border-radius:4px;}
.empty-state{text-align:center;color:#c0a882;font-size:15px;margin:auto;line-height:2.2;font-style:italic;font-family:'Playfair Display',serif;}
.sys-msg{text-align:center;font-size:11px;color:var(--mid);padding:2px 0;font-style:italic;letter-spacing:.5px;}
.msg-wrap{display:flex;gap:9px;align-items:flex-end;animation:msgIn .22s ease;}
.msg-wrap.mine{flex-direction:row-reverse;}.msg-wrap.theirs{flex-direction:row;}
.av{width:33px;height:33px;border-radius:50%;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.av-them{background:linear-gradient(145deg,var(--mocha),var(--espresso));color:var(--cream);}
.av-mine{background:var(--latte);color:var(--mocha);border:1.5px solid var(--border);}
.msg-inner{max-width:72%;}
.meta{font-size:10px;color:var(--mid);margin-bottom:4px;letter-spacing:.3px;}
.mine .meta{text-align:right;}
.bub{padding:10px 14px;border-radius:17px;font-size:15px;line-height:1.6;word-break:break-word;}
.bub-them{background:var(--foam);color:var(--ink);border:1px solid var(--border);border-bottom-left-radius:4px;box-shadow:0 2px 10px rgba(59,31,14,.07);}
.bub-mine{background:linear-gradient(135deg,var(--mocha),var(--espresso));color:var(--cream);border-bottom-right-radius:4px;box-shadow:0 3px 12px rgba(59,31,14,.22);}
#chatTypingBar,#floorTypingBar{display:none;align-items:center;gap:8px;padding:5px 16px;background:var(--foam);border-top:1px solid var(--border);flex-shrink:0;min-height:28px;}
.tcups{display:flex;gap:3px;}.tc{font-size:13px;animation:bob .8s ease-in-out infinite;display:inline-block;}
.tc:nth-child(2){animation-delay:.2s;}.tc:nth-child(3){animation-delay:.4s;}
.ttext{font-size:11px;color:var(--mid);font-style:italic;}
.input-bar{background:var(--foam);border-top:1px solid var(--border);padding:10px 12px;display:flex;gap:9px;align-items:center;flex-shrink:0;}
#chatMsgInput,#floorMsgInput{flex:1;border:1.5px solid var(--border);border-radius:999px;padding:11px 17px;font-size:15px;font-family:'Lato',sans-serif;color:var(--ink);background:var(--cream);outline:none;transition:border-color .2s,box-shadow .2s;}
#chatMsgInput:focus,#floorMsgInput:focus{border-color:var(--caramel);box-shadow:0 0 0 3px rgba(200,149,92,.15);}
#chatMsgInput::placeholder,#floorMsgInput::placeholder{color:#c0a882;}
#chatSendBtn,#floorSendBtn{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--caramel),var(--roast));color:var(--foam);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px;transition:opacity .2s,transform .1s;box-shadow:0 3px 12px rgba(139,69,19,.35);}
#chatSendBtn:hover,#floorSendBtn:hover{opacity:.88;}#chatSendBtn:active,#floorSendBtn:active{transform:scale(.90);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(min-width:768px){
  body{align-items:center;justify-content:center;}
  #loginScreen{width:100%;}
  #floorScreen,#chatBox{max-width:680px;width:100%;height:92vh;border-radius:24px;overflow:hidden;box-shadow:var(--shadow),0 0 0 1px var(--latte);}
  #tablesRoom{max-width:860px;width:100%;height:92vh;border-radius:24px;overflow:hidden;box-shadow:var(--shadow),0 0 0 1px var(--latte);}
  .page-header{border-radius:24px 24px 0 0;}
}
@media(max-width:680px){
  #roundTablesGrid{grid-template-columns:repeat(2,1fr);gap:28px 12px;}
  .rt-outer{width:110px;height:110px;}
  .rt-cup{font-size:24px;}
}
@media(max-width:400px){
  #roundTablesGrid{grid-template-columns:repeat(2,1fr);gap:20px 8px;}
  .rt-outer{width:96px;height:96px;}.rt-cup{font-size:21px;}.rt-name{font-size:9.5px;}
  .msg-inner{max-width:84%;}.bub{font-size:14px;padding:9px 12px;}
  .uname{display:none;}
  .tables-btn-label{display:none;}
  .tables-btn{padding:9px 12px;}
  .page-header{gap:6px;padding:10px 10px;}
  .ph-logo{width:34px;height:34px;font-size:15px;}
  .ph-title{font-size:14px;}
  .hbtn{width:30px;height:30px;font-size:13px;}
  .upill{padding:4px 8px 4px 5px;}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen">
  <div class="lcard">
    <div class="bean-emb">
      <div class="steam-w"><div class="steam-l"></div><div class="steam-l"></div><div class="steam-l"></div></div>
      <div class="bean-ring">â˜•</div>
    </div>
    <h1><em>Bean</em> Chat</h1>
    <p class="tagline">In loving memory of Dad Â· Always warm</p>
    <div class="lspecial">
      <div class="ls-drink" id="loginSpecialDrink"></div>
      <div class="ls-note"  id="loginSpecialNote"></div>
    </div>
    <div class="inp-g">
      <label>Your Name</label>
      <input id="nameInput" type="text" placeholder="e.g. Mam, Michael, Broâ€¦" onkeydown="handleJoinKey(event)" autofocus/>
    </div>
    <button class="join-btn" onclick="joinChat()">Step inside â˜•</button>
    <div class="l-btns">
      <button class="hbtn amb-btn" onclick="toggleAmbient()" title="CafÃ© ambience">ğŸµ</button>
      <button class="hbtn snd-btn" onclick="toggleSound()"   title="Sound">ğŸ””</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FLOOR SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="floorScreen">

  <div class="page-header">
    <div class="ph-logo">â˜•</div>
    <div class="ph-text">
      <div class="ph-title"><em>Bean</em> Chat</div>
      <div class="ph-sub"><span class="live-dot"></span> The Floor Â· Open to everyone</div>
    </div>
    <div class="ph-actions">
      <button class="tables-btn" onclick="goToTables()"><span>ğŸª‘</span><span class="tables-btn-label"> Tables</span></button>
      <button class="hbtn amb-btn" onclick="toggleAmbient()" title="CafÃ© ambience">ğŸµ</button>
      <button class="hbtn snd-btn" onclick="toggleSound()" title="Sound">ğŸ””</button>
    </div>
    <div class="upill">
      <div class="uav" id="floorUserAv">?</div>
      <span class="uname" id="floorUserName"></span>
    </div>
  </div>

  <div class="chalk">
    <span style="font-size:14px;flex-shrink:0">ğŸª„</span>
    <span class="ck-l">Today's Special Â·</span>
    <span class="ck-d special-fill">â€¦</span>
    <span class="ck-t time-greet"></span>
  </div>

  <div class="floor-welcome">
    <div class="fw-left">
      <h2>Welcome to <em>the floor</em> â˜•</h2>
      <p>Open chat Â· everyone sees everyone</p>
    </div>
    <div class="fw-count" id="floorCount">Loadingâ€¦</div>
  </div>

  <!-- Chat UI embedded in floor -->
  <div id="floorMsgs"></div>
  <div id="floorTypingBar"></div>
  <div class="input-bar">
    <input id="floorMsgInput" type="text" placeholder="Say something warm to everyoneâ€¦" onkeydown="handleMsgKey(event)"/>
    <button id="floorSendBtn" onclick="sendMessage()">â¤</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TABLES ROOM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tablesRoom">

  <div class="page-header">
    <div class="ph-logo">ğŸª‘</div>
    <div class="ph-text">
      <div class="ph-title"><em>Bean</em> Chat Â· Tables</div>
      <div class="ph-sub">Pick your spot â€” pull up a chair</div>
    </div>
    <button class="back-btn" onclick="tablesBackToFloor()">â† Floor</button>
    <div class="ph-actions">
      <button class="hbtn amb-btn" onclick="toggleAmbient()" title="CafÃ© ambience">ğŸµ</button>
      <button class="hbtn snd-btn" onclick="toggleSound()"   title="Sound">ğŸ””</button>
    </div>
    <div class="upill" style="margin-left:2px;">
      <div class="uav" id="tablesUserAv">?</div>
    </div>
  </div>

  <div class="chalk">
    <span style="font-size:14px;flex-shrink:0">ğŸª„</span>
    <span class="ck-l">Today's Special Â·</span>
    <span class="ck-d special-fill">â€¦</span>
    <span class="ck-t time-greet"></span>
  </div>

  <div id="tablesRoomBody">
    <div class="tr-intro">
      <h3>Choose your <em>table</em></h3>
      <p>Eight tables, each with its own vibe â€” tap to sit down.</p>
    </div>
    <div id="roundTablesGrid"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAT BOX (private table) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="chatBox">

  <div class="page-header">
    <div class="ph-logo" id="chatHeaderEmoji">â˜•</div>
    <div class="ph-text">
      <div class="ph-title">
        <em>Bean</em> Chat
        <span class="tbadge" id="chatHeaderBadge">â€¦</span>
      </div>
      <div class="ph-sub"><span class="live-dot"></span> Live Â· Always warm</div>
    </div>
    <button class="back-btn" id="chatBackBtn" onclick="leaveChat()">â† Tables</button>
    <div class="ph-actions">
      <button class="hbtn amb-btn" onclick="toggleAmbient()" title="CafÃ© ambience">ğŸµ</button>
      <button class="hbtn snd-btn" onclick="toggleSound()"   title="Sound">ğŸ””</button>
    </div>
    <div class="upill">
      <div class="uav" id="chatHeaderUser">?</div>
      <span class="uname" id="chatHeaderUserName"></span>
    </div>
  </div>

  <div class="chalk">
    <span style="font-size:14px;flex-shrink:0">ğŸª„</span>
    <span class="ck-l">Today's Special Â·</span>
    <span class="ck-d" id="chatSpecialFill">â€¦</span>
    <span class="ck-t" id="chatTimeGreet"></span>
  </div>

  <div class="seats-bar" id="chatSeatsBar">
    <span class="seats-label">At this table</span>
    <div id="chatSeatsList"></div>
  </div>

  <div id="chatMsgs"></div>
  <div id="chatTypingBar"></div>
  <div class="input-bar">
    <input id="chatMsgInput" type="text" placeholder="Pass something warm alongâ€¦" onkeydown="handleMsgKey(event)"/>
    <button id="chatSendBtn" onclick="sendMessage()">â¤</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const SPECIALS=[
    {drink:'Honey Oat Latte',note:'A golden hug in a cup'},
    {drink:'Cardamom Flat White',note:'Spice up your morning'},
    {drink:'Brown Sugar Cold Brew',note:'Smooth & slow, just like Sundays'},
    {drink:'Lavender Cortado',note:'Soft as a quiet afternoon'},
    {drink:'Hazelnut Cappuccino',note:'Nutty, warm, familiar'},
    {drink:'Cinnamon Americano',note:'Bold with a little sweetness'},
    {drink:'Vanilla Bean Macchiato',note:'Simple things done perfectly'},
  ];
  const s=SPECIALS[new Date().getDay()%SPECIALS.length];
  document.getElementById('loginSpecialDrink').textContent=s.drink;
  document.getElementById('loginSpecialNote').textContent=s.note;
  document.querySelectorAll('.special-fill').forEach(e=>e.textContent=`${s.drink} â€” ${s.note}`);
});
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}
</script>
</body>
</html>
